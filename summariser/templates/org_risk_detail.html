{% extends "base.html" %}
{% block title %}
  {% if risk.code %}{{ risk.code }} – {% else %}Risk R-{{ risk.id }} – {% endif %}
  {% if org %}{{ org.name }}{% else %}Organisation {{ org_id }}{% endif %}
{% endblock %}

{% block content %}

<div class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8 mt-4 mb-8">

  <!-- Header / breadcrumb -->
  <div class="flex items-center justify-between gap-3 mb-4">
    <div class="flex items-center gap-3">
      <a href="/orgs/{{ org_id }}/org-risks"
         class="text-sm text-emerald-800 hover:text-emerald-900 hover:underline">
        ← Back to risks
      </a>
    </div>
  </div>

  <!-- Risk header card -->
  <section class="panel p-4 sm:p-5 mb-6">
    <div class="flex flex-wrap items-start justify-between gap-3">
      <div>
        <div class="flex items-center gap-2 mb-1">
          <span class="inline-flex items-center rounded-full bg-emerald-50 px-3 py-1 text-xs font-semibold text-emerald-800 border border-emerald-200">
            {{ risk.code or ('R-' ~ risk.id) }}
          </span>
        </div>
        <h1 class="text-xl font-semibold leading-snug">
          {{ risk.title or 'Untitled risk' }}
        </h1>
        {% if org %}
          <p class="mt-1 text-sm text-gray-500">
            {{ org.name }}
          </p>
        {% endif %}
      </div>

      <!-- Status / severity / category -->
      <div class="flex flex-col items-end gap-1 text-xs">
        {% if risk.status %}
          <span class="inline-flex items-center rounded-full px-2.5 py-1 border text-[0.7rem]
                        {% if risk.status == 'Open' %}
                          bg-red-50 border-red-200 text-red-700
                        {% elif risk.status in ['In progress','Mitigated'] %}
                          bg-amber-50 border-amber-200 text-amber-700
                        {% else %}
                          bg-emerald-50 border-emerald-200 text-emerald-800
                        {% endif %}">
            Status: {{ risk.status }}
          </span>
        {% endif %}
        {% if risk.severity %}
          <span class="inline-flex items-center rounded-full px-2.5 py-1 bg-slate-50 border border-slate-200 text-[0.7rem] text-slate-700">
            Severity: {{ risk.severity }}
          </span>
        {% endif %}
        {% if risk.category %}
          <span class="inline-flex items-center rounded-full px-2.5 py-1 bg-slate-50 border border-slate-200 text-[0.7rem] text-slate-700">
            Category: {{ risk.category }}
          </span>
        {% endif %}
      </div>
    </div>

    <!-- Owner + timestamps -->
    <div class="mt-4 flex flex-wrap gap-x-6 gap-y-2 text-xs text-gray-500">
      {% if risk.owner_name or risk.owner_email %}
        <div>
          <span class="font-semibold text-gray-700">Owner:</span>
          {% if risk.owner_name %} {{ risk.owner_name }}{% endif %}
          {% if risk.owner_email %}
            <span class="ml-1 text-emerald-800">
              &lt;{{ risk.owner_email }}&gt;
            </span>
          {% endif %}
        </div>
      {% endif %}
      {% if risk.created_at %}
        <div>
          <span class="font-semibold text-gray-700">Created:</span>
          {{ risk.created_at }}
        </div>
      {% endif %}
      {% if risk.updated_at %}
        <div>
          <span class="font-semibold text-gray-700">Last updated:</span>
          {{ risk.updated_at }}
        </div>
      {% endif %}
    </div>

    <!-- Description -->
    {% if risk.description %}
      <div class="mt-4 border-t border-gray-100 pt-3">
        <h2 class="text-sm font-semibold text-gray-800 mb-1">Description</h2>
        <p class="text-sm leading-relaxed whitespace-pre-line">
          {{ risk.description }}
        </p>
      </div>
    {% endif %}
  </section>

  <!-- Two-column: controls + linked items -->
  <div class="grid gap-5 lg:grid-cols-5">

    <!-- Controls (left) -->
    <section class="lg:col-span-2 panel p-4 sm:p-5">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-semibold text-gray-800">
          Controls mitigating this risk
        </h2>
      </div>

      {% set has_linked_controls = false %}
      <ul class="space-y-2">
        {% for c in controls %}
          {% if c.id in linked_ids %}
            {% set has_linked_controls = true %}
            <li class="border border-emerald-100 bg-emerald-50/60 rounded-lg px-3 py-2">
              <div class="flex items-center justify-between gap-2">
                <div>
                  <div class="text-xs font-semibold text-emerald-900">
                    {{ c.code or ('C-' ~ c.id) }}
                  </div>
                  <div class="text-sm text-gray-900">
                    {{ c.title }}
                  </div>
                  {% if c.status %}
                    <div class="mt-0.5 text-[0.7rem] text-gray-600">
                      Status: {{ c.status }}
                    </div>
                  {% endif %}
                </div>
                <a href="/orgs/{{ org_id }}/controls"
                   class="text-[0.7rem] text-emerald-800 hover:text-emerald-900 hover:underline whitespace-nowrap">
                  View controls
                </a>
              </div>
            </li>
          {% endif %}
        {% endfor %}
      </ul>

      {% if not has_linked_controls %}
        <p class="text-sm text-gray-500 mt-1">
          No controls are currently linked to this risk.
        </p>
      {% endif %}

      <p class="mt-3 text-xs text-gray-400">
        To change which controls mitigate this risk, use the “Edit” / drawer UI from the risks list.
      </p>
    </section>

    <!-- Linked news items (right) -->
    <section class="lg:col-span-3 panel p-4 sm:p-5">
      <div class="flex items-center justify-between mb-3">
        <div>
          <h2 class="text-sm font-semibold text-gray-800">
            Linked news items
          </h2>
          <p class="text-xs text-gray-500 mt-0.5">
            Items you’ve explicitly mapped to this risk from the summaries screen.
          </p>
        </div>
      </div>

      {% if linked_items and linked_items|length %}
<section class="mt-8">
  <h2 class="text-sm font-semibold text-gray-800 mb-2">Linked news items</h2>
  <ul class="space-y-2">
    {% for it in linked_items %}
      <li class="border border-gray-100 rounded-lg p-2 bg-white flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <div>
          <a href="{{ it.link }}" target="_blank" rel="noopener"
             class="text-sm font-semibold text-emerald-700 hover:underline">
            {{ it.title or 'Untitled item' }}
          </a>
          <div class="text-xs text-gray-500 mt-0.5">
            {{ it.source or 'Unknown' }}
            {% if it.published_at %} • {{ it.published_at }}{% endif %}
          </div>
        </div>
        {% if it.ai_summary %}
          <p class="text-xs text-gray-700 sm:max-w-md">
            {{ it.ai_summary[:180] }}{% if it.ai_summary|length > 180 %}…{% endif %}
          </p>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
</section>
{% endif %}

    </section>
  </div>
</div>

{% endblock %}
