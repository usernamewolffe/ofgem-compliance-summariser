{% extends "base.html" %}
{% block title %}Risk {{ risk.code or ('R-' ~ risk.id) }} — {{ risk.title }}{% endblock %}

{% block content %}

<div class="page-title">
  <h1>
    {% if org %}{{ org.name }}{% else %}Organisation {{ org_id }}{% endif %}
    — Risk {{ risk.code or ('R-' ~ risk.id) }}
  </h1>
</div>

<div class="wrap" style="display:grid; grid-template-columns: minmax(0,2.2fr) minmax(260px,1fr); gap:1.5rem;">
  <!-- MAIN COLUMN -->
  <section class="panel" style="padding:1.25rem; background:#f9fbf9; border-radius:12px;">
    <header class="mb-4">
      <h2 class="text-lg font-semibold mb-1">{{ risk.title }}</h2>
      <div class="flex flex-wrap items-center gap-2 text-sm">
        {% if risk.code %}
          <span class="pill">Code: {{ risk.code }}</span>
        {% endif %}
        {% if risk.status %}
          <span class="pill">Status: {{ risk.status }}</span>
        {% endif %}
        {% if risk.severity %}
          <span class="pill">Severity: {{ risk.severity }}</span>
        {% endif %}
        {% if risk.category %}
          <span class="pill">Category: {{ risk.category }}</span>
        {% endif %}
      </div>
    </header>

    {% if risk.description %}
      <div class="prose text-sm leading-relaxed mb-6">
        <h3 class="text-base font-semibold mb-1">Description</h3>
        <p>{{ risk.description }}</p>
      </div>
    {% endif %}

    <!-- Linked controls -->
    <div class="mb-6">
      <h3 class="text-base font-semibold mb-2">Linked controls</h3>
      {% set has_any = False %}
      <ul class="grid gap-2">
        {% for c in controls %}
          {% if c.id in linked_ids %}
            {% set has_any = True %}
            <li class="border border-gray-200 rounded-lg px-3 py-2 text-sm flex items-center justify-between">
              <div>
                <div class="font-medium">
                  {% if c.code %}{{ c.code }} — {% endif %}
                  {{ c.title }}
                </div>
                {% if c.status %}
                  <div class="text-xs text-gray-500 mt-0.5">{{ c.status }}</div>
                {% endif %}
              </div>
              <a class="btn-muted text-xs" href="/controls/{{ c.id }}">View control</a>
            </li>
          {% endif %}
        {% endfor %}
      </ul>
      {% if not has_any %}
        <p class="muted text-sm">No controls have been linked to this risk yet.</p>
      {% endif %}
    </div>

    <!-- Linked items -->
    <div>
      <h3 class="text-base font-semibold mb-2">Linked news & items</h3>
      {% if linked_items and linked_items|length %}
        <ul class="grid gap-3">
          {% for it in linked_items %}
          <li class="card">
            <h4 class="text-sm font-semibold leading-snug">
              <a href="{{ it.link }}" target="_blank" rel="noopener"
                 class="text-emerald-700 hover:text-emerald-900 hover:underline">
                {{ it.title or 'Untitled item' }}
              </a>
            </h4>
            <div class="muted text-xs mt-1">
              {{ it.source or 'Unknown' }}
              {% if it.published_at %} • {{ it.published_at }}{% endif %}
            </div>
            {% set blurb = it.ai_summary or it.content or '' %}
            {% if blurb %}
              <p class="mt-2 text-xs leading-relaxed">
                {{ blurb[:260] }}{% if blurb|length > 260 %}…{% endif %}
              </p>
            {% endif %}
            <div class="mt-2">
              <a class="btn-muted text-xs" href="/items/{{ it.guid }}">View in summaries</a>
            </div>
          </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="muted text-sm">
          No items have been linked to this risk yet.
          Use the <strong>“Link to risk”</strong> dropdown on the Summaries page to add relevant Ofgem news and guidance here.
        </p>
      {% endif %}
    </div>
  </section>

  <!-- SIDE COLUMN -->
  <aside class="panel" style="padding:1rem; border-radius:12px;">
    <h3 class="text-sm font-semibold mb-2">Meta</h3>
    <dl class="text-sm space-y-1">
      <div class="flex justify-between gap-2">
        <dt class="text-gray-500">Created</dt>
        <dd>{{ risk.created_at or '—' }}</dd>
      </div>
      <div class="flex justify-between gap-2">
        <dt class="text-gray-500">Last updated</dt>
        <dd>{{ risk.updated_at or '—' }}</dd>
      </div>
      {% if risk.owner_name or risk.owner_email %}
      <div class="flex justify-between gap-2 mt-2">
        <dt class="text-gray-500">Owner</dt>
        <dd class="text-right">
          {% if risk.owner_name %}{{ risk.owner_name }}{% endif %}
          {% if risk.owner_email %}
            <div><a class="text-emerald-700 hover:underline" href="mailto:{{ risk.owner_email }}">{{ risk.owner_email }}</a></div>
          {% endif %}
        </dd>
      </div>
      {% endif %}
    </dl>

    <div class="mt-4 border-t border-gray-100 pt-3">
      <a class="btn-muted w-full text-center block text-sm" href="/orgs/{{ org_id }}/org-risks">
        ← Back to risks list
      </a>
    </div>
  </aside>
</div>

{% endblock %}
