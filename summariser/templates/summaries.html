{% extends "base.html" %}
{% block title %}Compliance Summaries{% endblock %}

{% block content %}
  <div class="page-title">
    <h1>Compliance Summaries</h1>
    <span class="pill">{{ entries|length }} shown</span>
  </div>

  <div class="wrap">
    <!-- Sidebar -->
    <aside class="panel">
      <form class="stack" action="/summaries" method="get" id="filterForm">
        <input type="hidden" name="per_page" value="{{ active.per_page|default(25) }}">

        <div class="section">
          <h3>Search</h3>
          <input type="text" name="q" value="{{ active.q }}" placeholder="Search title or content…">
        </div>

        <div class="section">
          <h3>Date</h3>
          <div class="row-gap">
            <input type="date" name="date_from" value="{{ active.date_from }}">
            <input type="date" name="date_to" value="{{ active.date_to }}">
          </div>
        </div>

        <div class="section">
          <h3>Sources</h3>
          <div class="row-gap">
            {% for s in all_sources %}
              <label class="chk">
                <input type="checkbox" name="sources" value="{{ s }}" {% if s in active.sources %}checked{% endif %}>
                <span>{{ s or 'Unknown' }}</span>
              </label>
            {% endfor %}
          </div>
        </div>

        <div class="section">
          <h3>Topics</h3>
          <div class="row-gap">
            {% for t in all_topics %}
              <label class="chk">
                <input type="checkbox" name="topics" value="{{ t }}" {% if t in active.topics %}checked{% endif %}>
                <span>{{ t }}</span>
              </label>
            {% endfor %}
          </div>
        </div>

        <div class="section" style="display:flex; gap:.5rem; flex-wrap:wrap;">
          <button class="btn primary" type="submit">Apply filters</button>
          <a class="btn" href="/summaries">Reset</a>
        </div>

        {% if uid %}
          <!-- Saved Filters -->
          <div class="section" style="margin-top:1rem;">
            <h3>Saved filters</h3>
            {% if saved_filters and saved_filters|length %}
              <ul class="stack" style="list-style:none; padding:0; margin:0;">
                {% for f in saved_filters %}
                  <li class="panel" style="padding:.5rem; display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
                    <div>
                      <strong>{{ f.name }}</strong>
                      {% if f.cadence %}
                        <span class="muted" style="font-size:.8rem; margin-left:.35rem;">{{ f.cadence }}</span>
                      {% endif %}
                    </div>
                    <div style="display:flex; gap:.4rem;">
                      <a class="btn small" href="/apply-saved-filter?filter_id={{ f.id }}">Apply</a>
                      <button class="btn small" data-delete-id="{{ f.id }}" aria-label="Delete saved filter">Delete</button>
                    </div>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="muted" style="margin:.5rem 0 0;">No saved filters yet.</p>
            {% endif %}
          </div>

          <!-- Save current as new filter -->
          <div class="section">
            <h3>Save current filter</h3>
            <div class="row-gap">
              <input type="text" id="saveName" placeholder="Name this filter…">
              <button class="btn" id="saveFilter">Save</button>
            </div>
            <p class="muted" style="font-size:.85rem; margin-top:.4rem;">
              Saves the current query, dates, selected sources & topics.
            </p>
          </div>
        {% endif %}
      </form>
    </aside>

    <!-- Results -->
    <section>
      <ul class="cards">
        {% for e in entries %}
          <li class="card" data-guid="{{ e.guid }}">
            <h4><a href="{{ e.link }}" target="_blank" rel="noopener">{{ e.title }}</a></h4>
            <div class="muted">{{ e.source }} • {{ e.published_at }}</div>
            <p style="margin:.6rem 0 0">
              {{ (e.ai_summary or e.summary or e.content or '')[:320] }}
              {% if (e.ai_summary or e.summary or e.content)|length > 320 %}…{% endif %}
            </p>

            {% if e.controls %}
              <div class="controls" style="margin-top:.5rem; display:flex; flex-wrap:wrap; gap:.4rem;">
                {% for c in e.controls %}
                  <span class="tag" style="background:#004b50; color:white;">{{ c }}</span>
                {% endfor %}
              </div>
            {% endif %}

            {% if e.tags %}
              <div class="tags" style="margin-top:.25rem;">
                {% for tag in e.tags %}
                  <span class="tag">{{ tag }}</span>
                {% endfor %}
              </div>
            {% endif %}

            <!-- Actions row -->
            <div style="display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin-top:.75rem;">
              <!-- Save to folder -->
              <button class="btn small" data-open-save>Save to folder</button>

              <!-- Tag for organisation -->
              <button class="btn small" data-open-tag>Tag to site/control</button>

              <!-- Send to colleague -->
              <form action="/send" method="post" style="display:flex; gap:.5rem; align-items:center; margin-left:auto;">
                <input type="hidden" name="guid" value="{{ e.guid }}">
                <input
                  type="email"
                  name="email"
                  placeholder="colleague@example.com"
                  required
                  style="flex:1; padding:.25rem .5rem; border:1px solid #ddd; border-radius:6px; min-width:220px;"
                >
                <button type="submit" class="btn small primary">Send</button>
              </form>
            </div>

            <!-- Inline status messages -->
            <div class="muted" data-status style="margin-top:.5rem; display:none;"></div>
          </li>
        {% endfor %}
      </ul>

      <!-- Pagination -->
      {% if total_pages > 1 %}
        <nav class="pagination">
          {% if page > 1 %}
            <a href="?{{ urlencode({'q':active.q,'date_from':active.date_from,'date_to':active.date_to}, doseq=True) }}&{% for s in active.sources %}sources={{ s }}&{% endfor %}{% for t in active.topics %}topics={{ t }}&{% endfor %}page={{ page-1 }}&per_page={{ active.per_page }}">‹ Prev</a>
          {% endif %}
          {% for n in page_numbers %}
            {% if n == page %}
              <span class="active">{{ n }}</span>
            {% else %}
              <a href="?{{ urlencode({'q':active.q,'date_from':active.date_from,'date_to':active.date_to}, doseq=True) }}&{% for s in active.sources %}sources={{ s }}&{% endfor %}{% for t in active.topics %}topics={{ t }}&{% endfor %}page={{ n }}&per_page={{ active.per_page }}">{{ n }}</a>
            {% endif %}
          {% endfor %}
          {% if page < total_pages %}
            <a href="?{{ urlencode({'q':active.q,'date_from':active.date_from,'date_to':active.date_to}, doseq=True) }}&{% for s in active.sources %}sources={{ s }}&{% endfor %}{% for t in active.topics %}topics={{ t }}&{% endfor %}page={{ page+1 }}&per_page={{ active.per_page }}">Next ›</a>
          {% endif %}
        </nav>
      {% endif %}
    </section>
  </div>

  <!-- Save dialog -->
  <dialog id="dlgSave" style="border:none; border-radius:12px; padding:0; max-width:560px; width:96%;">
    <form method="dialog" style="padding:1rem; background:#fff; border:1px solid var(--line); border-radius:12px;">
      <h3 style="margin:.25rem 0 1rem;">Save to folder</h3>
      <input type="hidden" name="guid">
      <div class="stack">
        <label>Folder
          <select name="folder_id" id="saveFolderSelect">
            <option value="">— Choose folder —</option>
          </select>
        </label>
        <div style="display:flex; gap:.5rem; align-items:center;">
          <input type="text" id="newFolderName" placeholder="New folder name…" style="flex:1; padding:.55rem .6rem; border:1px solid var(--line); border-radius:8px;">
          <button class="btn" id="btnCreateFolder" type="button">Create</button>
        </div>
        <label>Note (optional)
          <input type="text" name="note" placeholder="Why is this useful?">
        </label>
      </div>
      <div style="display:flex; gap:.5rem; justify-content:flex-end; margin-top:1rem;">
        <button type="button" class="btn" data-cancel>Cancel</button>
        <button type="submit" class="btn primary" data-submit>Save</button>
      </div>
    </form>
  </dialog>

  <!-- Tag dialog -->
  <dialog id="dlgTag" style="border:none; border-radius:12px; padding:0; max-width:680px; width:96%;">
    <form method="dialog" style="padding:1rem; background:#fff; border:1px solid var(--line); border-radius:12px;">
      <h3 style="margin:.25rem 0 1rem;">Tag to site / control</h3>
      <input type="hidden" name="guid">
      <div class="stack">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:.5rem;">
          <label>Site (optional)
            <select name="site_id" id="tagSiteSelect">
              <option value="">Org-wide</option>
            </select>
          </label>
          <label>Control (optional)
            <select name="org_control_id" id="tagControlSelect">
              <option value="">— Choose control —</option>
            </select>
          </label>
        </div>
      </div>
      <div style="display:flex; gap:.5rem; justify-content:flex-end; margin-top:1rem;">
        <button type="button" class="btn" data-cancel>Cancel</button>
        <button type="submit" class="btn primary" data-submit>Tag</button>
      </div>
    </form>
  </dialog>
{% endblock %}

{% block scripts %}
<script>
(function() {
  // ---------- Delete saved filter ----------
  document.querySelectorAll('[data-delete-id]')?.forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const id = btn.getAttribute('data-delete-id');
      if (!id) return;
      if (!confirm('Delete this saved filter?')) return;
      const res = await fetch(`/api/saved-filters/${encodeURIComponent(id)}`, { method: 'DELETE' });
      if (res.ok) window.location.reload();
      else alert('Failed to delete filter.');
    });
  });

  // ---------- Save current filters ----------
  const saveBtn = document.getElementById('saveFilter');
  if (saveBtn) {
    saveBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      const nameInput = document.getElementById('saveName');
      const name = (nameInput?.value || '').trim();
      if (!name) { alert('Name your filter first.'); return; }

      const url = new URL(window.location.href);
      const params = new URLSearchParams(url.search);
      const payload = { name, params: {} };
      ['q','date_from','date_to','per_page'].forEach(k => {
        const v = params.get(k);
        if (v) payload.params[k] = v;
      });
      ['sources','topics'].forEach(k => {
        const vals = [...params.getAll(k)];
        if (vals.length) payload.params[k] = vals;
      });

      const r = await fetch('/api/saved-filters', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        credentials: 'same-origin'
      });
      if (!r.ok) { alert('Failed to save filter.'); return; }
      if (nameInput) nameInput.value = '';
      window.location.reload();
    });
  }

  // ---------- Helpers ----------
  const orgId = {{ org_id or 1 }};
  const dlgSave = document.getElementById('dlgSave');
  const dlgTag  = document.getElementById('dlgTag');

  async function loadFolders() {
    const r = await fetch('/api/folders', { credentials: 'same-origin' });
    if (!r.ok) return [];
    return r.json();
  }

  async function createFolder(name) {
    const r = await fetch('/api/folders', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ name }),
      credentials: 'same-origin'
    });
    if (!r.ok) throw new Error('Failed to create folder');
    return r.json();
  }

  async function saveItem(guid, folder_id, note) {
    return fetch('/api/items/save', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ guid, folder_id, note }),
      credentials: 'same-origin'
    });
  }

  async function loadSites() {
    const r = await fetch(`/api/orgs/${orgId}/sites`, { credentials: 'same-origin' });
    if (!r.ok) return [];
    return r.json();
  }

  async function loadOrgControls() {
    const r = await fetch(`/api/orgs/${orgId}/org-controls`, { credentials: 'same-origin' });
    if (!r.ok) return [];
    return r.json();
  }

  async function tagItem(guid, site_id, org_control_id) {
    return fetch('/api/items/tag', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ guid, org_id: orgId, site_id, org_control_id }),
      credentials: 'same-origin'
    });
  }

  function showStatus(cardEl, msg, ok=true) {
    const el = cardEl.querySelector('[data-status]');
    if (!el) return;
    el.textContent = msg;
    el.style.display = 'block';
    el.style.color = ok ? 'var(--muted)' : '#b00020';
  }

  // ---------- Save dialog ----------
  document.querySelectorAll('[data-open-save]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const card = btn.closest('[data-guid]');
      const guid = card?.getAttribute('data-guid');
      if (!guid) return;

      dlgSave.querySelector('input[name="guid"]').value = guid;

      const select = document.getElementById('saveFolderSelect');
      select.innerHTML = '<option value="">— Choose folder —</option>';
      try {
        const folders = await loadFolders();
        folders.forEach(f => {
          const opt = document.createElement('option');
          opt.value = f.id;
          opt.textContent = f.name;
          select.appendChild(opt);
        });
      } catch(e) { console.error(e); }

      dlgSave.showModal();
    });
  });

  document.getElementById('btnCreateFolder')?.addEventListener('click', async (e) => {
    e.preventDefault();
    const name = (document.getElementById('newFolderName')?.value || '').trim();
    if (!name) { alert('Folder name required'); return; }
    try {
      const folder = await createFolder(name);
      const select = document.getElementById('saveFolderSelect');
      const opt = document.createElement('option');
      opt.value = folder.id;
      opt.textContent = folder.name;
      select.appendChild(opt);
      select.value = folder.id;
      document.getElementById('newFolderName').value = '';
    } catch(err) {
      alert('Failed to create folder');
    }
  });

  dlgSave?.querySelector('[data-submit]')?.addEventListener('click', async (e) => {
    e.preventDefault();
    const guid = dlgSave.querySelector('input[name="guid"]').value;
    const folder_id = dlgSave.querySelector('select[name="folder_id"]').value || null;
    const note = dlgSave.querySelector('input[name="note"]').value || null;

    const card = document.querySelector(`[data-guid="${CSS.escape(guid)}"]`);
    try {
      const r = await saveItem(guid, folder_id ? Number(folder_id) : null, note);
      if (r.ok) {
        showStatus(card, 'Saved to folder ✔');
        dlgSave.close();
      } else {
        const t = await r.text();
        showStatus(card, 'Save failed: ' + t, false);
      }
    } catch (err) {
      showStatus(card, 'Save failed', false);
    }
  });
  dlgSave?.querySelector('[data-cancel]')?.addEventListener('click', () => dlgSave.close());

  // ---------- Tag dialog ----------
  document.querySelectorAll('[data-open-tag]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const card = btn.closest('[data-guid]');
      const guid = card?.getAttribute('data-guid');
      if (!guid) return;

      dlgTag.querySelector('input[name="guid"]').value = guid;

      const siteSel = document.getElementById('tagSiteSelect');
      const ctrlSel = document.getElementById('tagControlSelect');
      siteSel.innerHTML = '<option value="">Org-wide</option>';
      ctrlSel.innerHTML = '<option value="">— Choose control —</option>';

      try {
        const [sites, ctrls] = await Promise.all([loadSites(), loadOrgControls()]);
        sites.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.id;
          opt.textContent = s.name;
          siteSel.appendChild(opt);
        });
        ctrls.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = (c.code ? c.code + ' — ' : '') + c.title + (c.site_name ? ` (${c.site_name})` : '');
          ctrlSel.appendChild(opt);
        });
      } catch (e) { console.error(e); }

      dlgTag.showModal();
    });
  });

  dlgTag?.querySelector('[data-submit]')?.addEventListener('click', async (e) => {
    e.preventDefault();
    const guid = dlgTag.querySelector('input[name="guid"]').value;
    const site_id = dlgTag.querySelector('select[name="site_id"]').value || null;
    const org_control_id = dlgTag.querySelector('select[name="org_control_id"]').value || null;
    const card = document.querySelector(`[data-guid="${CSS.escape(guid)}"]`);
    try {
      const r = await tagItem(
        guid,
        site_id ? Number(site_id) : null,
        org_control_id ? Number(org_control_id) : null
      );
      if (r.ok) {
        showStatus(card, 'Tagged ✔');
        dlgTag.close();
      } else {
        const t = await r.text();
        showStatus(card, 'Tag failed: ' + t, false);
      }
    } catch(err) {
      showStatus(card, 'Tag failed', false);
    }
  });
  dlgTag?.querySelector('[data-cancel]')?.addEventListener('click', () => dlgTag.close());
})();
</script>
{% endblock %}
