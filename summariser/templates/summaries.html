{% extends "base.html" %}
{% block title %}Compliance Summaries{% endblock %}

{% block content %}
  <div class="page-title">
    <h1>Compliance Summaries</h1>
    <span class="pill">{{ entries|length }} shown</span>
  </div>

  <div class="wrap">
    <!-- Sidebar -->
    <aside class="panel">
      <form class="stack" action="/summaries" method="get">
        <input type="hidden" name="per_page" value="{{ active.per_page|default(25) }}">
        <div class="section">
          <h3>Search</h3>
          <input type="text" name="q" value="{{ active.q }}" placeholder="Search title or content…">
        </div>

        <div class="section">
          <h3>Date</h3>
          <div class="row-gap">
            <input type="date" name="date_from" value="{{ active.date_from }}">
            <input type="date" name="date_to" value="{{ active.date_to }}">
          </div>
        </div>

        <div class="section">
          <h3>Sources</h3>
          <div class="row-gap">
            {% for s in all_sources %}
              <label class="chk">
                <input type="checkbox" name="sources" value="{{ s }}" {% if s in active.sources %}checked{% endif %}>
                <span>{{ s or 'Unknown' }}</span>
              </label>
            {% endfor %}
          </div>
        </div>

        <div class="section">
          <h3>Topics</h3>
          <div class="row-gap">
            {% for t in all_topics %}
              <label class="chk">
                <input type="checkbox" name="topics" value="{{ t }}" {% if t in active.topics %}checked{% endif %}>
                <span>{{ t }}</span>
              </label>
            {% endfor %}
          </div>
        </div>

        <div class="section">
          <button class="btn primary" type="submit">Apply filters</button>
          <a class="btn" href="/summaries">Reset</a>
        </div>
      </form>
    </aside>

    <!-- Results -->
    <section>
      <ul class="cards">
        {% for e in entries %}
          <li class="card">
            <h4><a href="{{ e.link }}" target="_blank" rel="noopener">{{ e.title }}</a></h4>
            <div class="muted">{{ e.source }} • {{ e.published_at }}</div>
            <p style="margin:.6rem 0 0">
              {{ (e.ai_summary or e.summary or e.content or '')[:320] }}{% if (e.ai_summary or e.summary or e.content)|length > 320 %}…{% endif %}
            </p>
            {% if e.tags %}
              <div class="tags" style="margin-top:.5rem">
                {% for tag in e.tags %}
                  <span class="tag">{{ tag }}</span>
                {% endfor %}
              </div>
            {% endif %}
            <div class="meta">
              <a href="/api/ai-summary" style="display:none">preload</a>
            </div>
          </li>
        {% endfor %}
      </ul>

      <!-- Pagination -->
      {% if total_pages > 1 %}
        <nav class="pagination">
          {% if page > 1 %}
            <a href="?{{ urlencode({'q':active.q,'date_from':active.date_from,'date_to':active.date_to}, doseq=True) }}&{% for s in active.sources %}sources={{ s }}&{% endfor %}{% for t in active.topics %}topics={{ t }}&{% endfor %}page={{ page-1 }}&per_page={{ active.per_page }}">‹ Prev</a>
          {% endif %}
          {% for n in page_numbers %}
            {% if n == page %}
              <span class="active">{{ n }}</span>
            {% else %}
              <a href="?{{ urlencode({'q':active.q,'date_from':active.date_from,'date_to':active.date_to}, doseq=True) }}&{% for s in active.sources %}sources={{ s }}&{% endfor %}{% for t in active.topics %}topics={{ t }}&{% endfor %}page={{ n }}&per_page={{ active.per_page }}">{{ n }}</a>
            {% endif %}
          {% endfor %}
          {% if page < total_pages %}
            <a href="?{{ urlencode({'q':active.q,'date_from':active.date_from,'date_to':active.date_to}, doseq=True) }}&{% for s in active.sources %}sources={{ s }}&{% endfor %}{% for t in active.topics %}topics={{ t }}&{% endfor %}page={{ page+1 }}&per_page={{ active.per_page }}">Next ›</a>
          {% endif %}
        </nav>
      {% endif %}
    </section>
  </div>
{% endblock %}


{% block scripts %}
<script>
    const res = await fetch('/items.json');       // convenience route
// or
// const res = await fetch('/public/items.json');

  // Sources select/unselect
  function setAllSources(c){document.querySelectorAll('#source-form input[name="sources"]').forEach(b=>b.checked=c);}
  document.getElementById('selectAllSources')?.addEventListener('click',()=>setAllSources(true));
  document.getElementById('clearAllSources')?.addEventListener('click',()=>setAllSources(false));

  // Topics dropdown
  const dropdown=document.querySelector('#topicDropdown > div[role="menu"]');
  document.getElementById('topicToggle')?.addEventListener('click',()=>dropdown.classList.toggle('hidden'));
  document.addEventListener('click',e=>{const root=document.getElementById('topicDropdown'); if(root && !root.contains(e.target)) dropdown.classList.add('hidden');});
  function setAllTopics(c){document.querySelectorAll('#topicDropdown input[name="topics"]').forEach(b=>b.checked=c);}
  document.getElementById('selectAllTopics')?.addEventListener('click',()=>setAllTopics(true));
  document.getElementById('clearAllTopics')?.addEventListener('click',()=>setAllTopics(false));

  // AI modal
  const aiModal=document.getElementById('aiModal'); const aiModalBody=document.getElementById('aiModalBody');
  document.getElementById('aiModalClose')?.addEventListener('click',()=>aiModal.classList.add('hidden'));
  document.querySelectorAll('.ai-btn').forEach(btn=>{
    btn.addEventListener('click',async()=>{
      aiModal.classList.remove('hidden'); aiModalBody.textContent='Summarising…';
      const guid=btn.dataset.guid;
      try{
        const r=await fetch('/api/ai-summary',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({guid})});
        const d=await r.json(); aiModalBody.textContent=d.summary||'No summary.';
      }catch{ aiModalBody.textContent='Failed to summarise.'; }
    });
  });

  // Folder save modal
  let pendingGuid=null; const saveModal=document.getElementById('saveModal'); const folderSelect=document.getElementById('folderSelect');
  async function loadFolders(){folderSelect.innerHTML='<option value="">(No folder)</option>'; const r=await fetch('/api/folders',{credentials:'same-origin'}); const d=await r.json(); (d.folders||[]).forEach(f=>{const o=document.createElement('option');o.value=f.id;o.textContent=f.name;folderSelect.appendChild(o);});}
  async function createFolder(){const n=document.getElementById('newFolderName').value.trim(); if(!n) return alert('Enter a folder name'); const r=await fetch('/api/folders',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'same-origin',body:JSON.stringify({name:n})}); if(!r.ok){alert('Failed to create folder');return;} document.getElementById('newFolderName').value=''; loadFolders();}
  async function saveItem(){const id=folderSelect.value||null; const r=await fetch('/api/save',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'same-origin',body:JSON.stringify({guid:pendingGuid,folder_id:id?Number(id):null})}); if(r.status===409){alert('Already saved in this folder');return;} if(!r.ok){alert('Failed to save');return;} alert('Saved successfully'); saveModal.classList.add('hidden');}
  document.getElementById('createFolderBtn')?.addEventListener('click',createFolder);
  document.getElementById('saveConfirm')?.addEventListener('click',saveItem);
  document.getElementById('saveCancel')?.addEventListener('click',()=>saveModal.classList.add('hidden'));
  document.querySelectorAll('.save-btn').forEach(b=>b.addEventListener('click',()=>{pendingGuid=b.dataset.guid; saveModal.classList.remove('hidden'); loadFolders();}));

  // Saved filters (list/create/apply/delete)
  async function loadSaved(){
    const list=document.getElementById('savedList'); if(!list) return;
    list.innerHTML='<div class="text-gray-500">Loading…</div>';
    try{
      const r=await fetch('/api/saved-filters'); const data=await r.json(); const filters=data.filters||[];
      if(!filters.length){list.innerHTML='<div class="text-gray-500">No saved filters yet.</div>';return;}
      list.innerHTML='';
      filters.forEach(f=>{
        const row=document.createElement('div');
        row.className='flex items-center justify-between gap-2 border rounded-md px-2 py-1';
        const left=document.createElement('div'); left.innerHTML=`<strong>${f.name}</strong>`;
        const actions=document.createElement('div'); actions.className='flex gap-2';
        const applyBtn=document.createElement('a'); applyBtn.className='px-2 py-1 border rounded text-sm hover:bg-gray-50'; applyBtn.href=`/apply-saved-filter?filter_id=${encodeURIComponent(f.id)}`; applyBtn.textContent='Apply';
        const delBtn=document.createElement('button'); delBtn.className='px-2 py-1 border rounded text-sm text-red-600 hover:bg-red-50'; delBtn.textContent='Delete';
        delBtn.addEventListener('click',async()=>{if(!confirm('Delete saved filter?'))return; await fetch(`/api/saved-filters/${f.id}`,{method:'DELETE'}); loadSaved();});
        actions.append(applyBtn, delBtn); row.append(left, actions); list.appendChild(row);
      });
    }catch(e){console.error(e); list.innerHTML='<div class="text-gray-500">Failed to load saved filters.</div>';}
  }
  document.getElementById('saveFilter')?.addEventListener('click',async(e)=>{
    e.preventDefault();
    const nameInput=document.getElementById('saveName'); const name=(nameInput.value||'').trim();
    if(!name) return alert('Name your filter first.');
    const url=new URL(window.location.href); const params=new URLSearchParams(url.search);
    const payload={name, params:{}};
    ['q','date_from','date_to','per_page'].forEach(k=>{const v=params.get(k); if(v) payload.params[k]=v;});
    ['sources','topics'].forEach(k=>{const vals=[...params.getAll(k)]; if(vals.length) payload.params[k]=vals;});
    const res=await fetch('/api/saved-filters',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!res.ok){alert('Failed to save filter.');return;}
    nameInput.value=''; loadSaved();
  });
  document.getElementById('refreshSaved')?.addEventListener('click',e=>{e.preventDefault(); loadSaved();});
  loadSaved();
</script>
{% endblock %}
