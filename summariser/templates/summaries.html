{% extends "base.html" %}
{% block title %}Compliance Summaries{% endblock %}

{% block content %}
  <div class="page-title">
    <h1>Compliance Summaries</h1>
    <span class="pill">{{ entries|length }} shown</span>
  </div>

  <div class="wrap">
    <!-- Sidebar -->
    <aside class="panel">
      <form class="stack" action="/summaries" method="get" id="filterForm">
        <input type="hidden" name="per_page" value="{{ active.per_page|default(25) }}">

        <div class="section">
          <h3>Search</h3>
          <input type="text" name="q" value="{{ active.q }}" placeholder="Search title or content…">
        </div>

        <div class="section">
          <h3>Date</h3>
          <div class="row-gap">
            <input type="date" name="date_from" value="{{ active.date_from }}">
            <input type="date" name="date_to" value="{{ active.date_to }}">
          </div>
        </div>

        <div class="section">
          <h3>Sources</h3>
          <div class="row-gap">
            {% for s in all_sources %}
              <label class="chk">
                <input type="checkbox" name="sources" value="{{ s }}" {% if s in active.sources %}checked{% endif %}>
                <span>{{ s or 'Unknown' }}</span>
              </label>
            {% endfor %}
          </div>
        </div>

        <div class="section">
          <h3>Topics</h3>
          <div class="row-gap">
            {% for t in all_topics %}
              <label class="chk">
                <input type="checkbox" name="topics" value="{{ t }}" {% if t in active.topics %}checked{% endif %}>
                <span>{{ t }}</span>
              </label>
            {% endfor %}
          </div>
        </div>

        <div class="section" style="display:flex; gap:.5rem; flex-wrap:wrap;">
          <button class="btn primary" type="submit">Apply filters</button>
          <a class="btn" href="/summaries">Reset</a>
        </div>

        {% if uid %}
          <!-- Saved Filters -->
          <div class="section" style="margin-top:1rem;">
            <h3>Saved filters</h3>
            {% if saved_filters and saved_filters|length %}
              <ul class="stack" style="list-style:none; padding:0; margin:0;">
                {% for f in saved_filters %}
                  <li class="panel" style="padding:.5rem; display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
                    <div>
                      <strong>{{ f.name }}</strong>
                      {% if f.cadence %}
                        <span class="muted" style="font-size:.8rem; margin-left:.35rem;">{{ f.cadence }}</span>
                      {% endif %}
                    </div>
                    <div style="display:flex; gap:.4rem;">
                      <a class="btn small" href="/apply-saved-filter?filter_id={{ f.id }}">Apply</a>
                      <button class="btn small" data-delete-id="{{ f.id }}" aria-label="Delete saved filter">Delete</button>
                    </div>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="muted" style="margin:.5rem 0 0;">No saved filters yet.</p>
            {% endif %}
          </div>

          <!-- Save current as new filter -->
          <div class="section">
            <h3>Save current filter</h3>
            <div class="row-gap">
              <input type="text" id="saveName" placeholder="Name this filter…">
              <button class="btn" id="saveFilter">Save</button>
            </div>
            <p class="muted" style="font-size:.85rem; margin-top:.4rem;">
              Saves the current query, dates, selected sources & topics.
            </p>
          </div>
        {% endif %}
      </form>
    </aside>

    <!-- Results -->
    <section>
      <ul class="cards">
        {% for e in entries %}
          <li class="card">
            <h4><a href="{{ e.link }}" target="_blank" rel="noopener">{{ e.title }}</a></h4>
            <div class="muted">{{ e.source }} • {{ e.published_at }}</div>
            <p style="margin:.6rem 0 0">
              {{ (e.ai_summary or e.summary or e.content or '')[:320] }}
              {% if (e.ai_summary or e.summary or e.content)|length > 320 %}…{% endif %}
            </p>

            {% if e.controls %}
              <div class="controls" style="margin-top:.5rem; display:flex; flex-wrap:wrap; gap:.4rem;">
                {% for c in e.controls %}
                  <span class="tag" style="background:#004b50; color:white;">{{ c }}</span>
                {% endfor %}
              </div>
            {% endif %}

            {% if e.tags %}
              <div class="tags" style="margin-top:.25rem;">
                {% for tag in e.tags %}
                  <span class="tag">{{ tag }}</span>
                {% endfor %}
              </div>
            {% endif %}

            <!-- ✅ Send to colleague form -->
            <form action="/send" method="post" style="margin-top:.75rem; display:flex; gap:.5rem; align-items:center;">
              <input type="hidden" name="guid" value="{{ e.guid }}">
              <input
                type="email"
                name="email"
                placeholder="colleague@example.com"
                required
                style="flex:1; padding:.25rem .5rem; border:1px solid #ddd; border-radius:6px;"
              >
              <button
                type="submit"
                style="padding:.25rem .75rem; border:none; background:#004b50; color:white; border-radius:6px; cursor:pointer;"
              >
                Send
              </button>
            </form>
          </li>
        {% endfor %}
      </ul>

      <!-- Pagination -->
      {% if total_pages > 1 %}
        <nav class="pagination">
          {% if page > 1 %}
            <a href="?{{ urlencode({'q':active.q,'date_from':active.date_from,'date_to':active.date_to}, doseq=True) }}&{% for s in active.sources %}sources={{ s }}&{% endfor %}{% for t in active.topics %}topics={{ t }}&{% endfor %}page={{ page-1 }}&per_page={{ active.per_page }}">‹ Prev</a>
          {% endif %}
          {% for n in page_numbers %}
            {% if n == page %}
              <span class="active">{{ n }}</span>
            {% else %}
              <a href="?{{ urlencode({'q':active.q,'date_from':active.date_from,'date_to':active.date_to}, doseq=True) }}&{% for s in active.sources %}sources={{ s }}&{% endfor %}{% for t in active.topics %}topics={{ t }}&{% endfor %}page={{ n }}&per_page={{ active.per_page }}">{{ n }}</a>
            {% endif %}
          {% endfor %}
          {% if page < total_pages %}
            <a href="?{{ urlencode({'q':active.q,'date_from':active.date_from,'date_to':active.date_to}, doseq=True) }}&{% for s in active.sources %}sources={{ s }}&{% endfor %}{% for t in active.topics %}topics={{ t }}&{% endfor %}page={{ page+1 }}&per_page={{ active.per_page }}">Next ›</a>
          {% endif %}
        </nav>
      {% endif %}
    </section>
  </div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  // Delete a saved filter
  document.querySelectorAll('[data-delete-id]')?.forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const id = btn.getAttribute('data-delete-id');
      if (!id) return;
      if (!confirm('Delete this saved filter?')) return;
      const res = await fetch(`/api/saved-filters/${encodeURIComponent(id)}`, { method: 'DELETE' });
      if (res.ok) window.location.reload();
      else alert('Failed to delete filter.');
    });
  });

  // Save current filters as a named saved filter
  const saveBtn = document.getElementById('saveFilter');
  if (saveBtn) {
    saveBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      const nameInput = document.getElementById('saveName');
      const name = (nameInput?.value || '').trim();
      if (!name) { alert('Name your filter first.'); return; }

      const url = new URL(window.location.href);
      const params = new URLSearchParams(url.search);
      const payload = { name, params: {} };
      ['q','date_from','date_to','per_page'].forEach(k => {
        const v = params.get(k);
        if (v) payload.params[k] = v;
      });
      ['sources','topics'].forEach(k => {
        const vals = [...params.getAll(k)];
        if (vals.length) payload.params[k] = vals;
      });

      const r = await fetch('/api/saved-filters', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        credentials: 'same-origin'
      });
      if (!r.ok) { alert('Failed to save filter.'); return; }
      if (nameInput) nameInput.value = '';
      window.location.reload();
    });
  }
})();
</script>
{% endblock %}
