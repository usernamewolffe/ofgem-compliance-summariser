{% extends "base.html" %}
{% block title %}{{ org.name }} — Risks{% endblock %}

{% block content %}
<div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 py-4 grid gap-4 lg:grid-cols-[320px_1fr]">

  <!-- Sidebar -->
  <aside class="rounded-xl border border-gray-100 p-4 bg-white">
    <nav class="text-xs text-gray-500 mb-2">
      <a href="/orgs/{{ org_id }}" class="hover:underline">{{ org.name }}</a> / <span>Corporate risks</span>
    </nav>

    <h2 class="text-lg font-semibold">Corporate risks</h2>
    <p class="text-sm text-gray-600 mt-1">
      Risks that apply at the organisation level (not tied to a specific site).
    </p>

    <!-- Quick links -->
    <div class="mt-4 grid grid-cols-2 gap-2 text-sm">
      <a href="/orgs/{{ org_id }}/org-controls" class="px-3 py-2 border rounded-md hover:bg-gray-50">Org controls</a>
      <a href="/orgs/{{ org_id }}/sites" class="px-3 py-2 border rounded-md hover:bg-gray-50">All sites</a>
    </div>

    <!-- Filters -->
    <form method="get" class="mt-4 space-y-2 text-sm">
      {% if status_choices %}
        <label class="block">
          <span class="text-gray-600">Status</span>
          <select name="status" class="mt-1 w-full rounded-md border border-gray-300 px-2 py-1.5">
            <option value="">Any</option>
            {% for s in status_choices %}
              <option value="{{ s }}" {% if active.status == s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
        </label>
      {% endif %}

      {% if severity_choices %}
        <label class="block">
          <span class="text-gray-600">Severity</span>
          <select name="severity" class="mt-1 w-full rounded-md border border-gray-300 px-2 py-1.5">
            <option value="">Any</option>
            {% for v in severity_choices %}
              <option value="{{ v }}" {% if active.severity == v %}selected{% endif %}>{{ v }}</option>
            {% endfor %}
          </select>
        </label>
      {% endif %}

      {% if category_choices %}
        <label class="block">
          <span class="text-gray-600">Category</span>
          <select name="category" class="mt-1 w-full rounded-md border border-gray-300 px-2 py-1.5">
            <option value="">Any</option>
            {% for c in category_choices %}
              <option value="{{ c }}" {% if active.category == c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </label>
      {% endif %}

      <div class="flex gap-2">
        <button class="px-3 py-1.5 border rounded-md hover:bg-gray-50" type="submit">Apply</button>
        <a class="px-3 py-1.5 border rounded-md hover:bg-gray-50" href="/orgs/{{ org_id }}/org-risks">Reset</a>
      </div>
    </form>
  </aside>

  <!-- Main -->
  <main class="space-y-4">
    <div class="flex items-center justify-between">
      <h3 class="text-base font-semibold">Risks ({{ risks|length if risks is defined else 0 }})</h3>
      <div class="flex gap-2">
        <a class="px-3 py-1.5 text-sm border rounded-md hover:bg-gray-50"
           href="/orgs/{{ org_id }}">Back to overview</a>
        <a class="px-3 py-1.5 text-sm border rounded-md hover:bg-gray-50"
           href="/orgs/{{ org_id }}/org-risks/new">+ New risk</a>
      </div>
    </div>

    {% if not risks or risks|length == 0 %}
      <div class="rounded-xl border border-gray-100 bg-white p-4 text-sm text-gray-600">
        No Corporate risks yet. Click <em>+ New risk</em> to add one.
      </div>
    {% else %}
      <div class="rounded-xl border border-gray-100 bg-white overflow-hidden">
        <table class="w-full text-sm">
          <thead class="bg-gray-50 text-gray-600">
            <tr>
              <th class="text-left px-4 py-2">Risk</th>
              <th class="text-left px-4 py-2">Status</th>
              <th class="text-left px-4 py-2">Severity</th>
              <th class="text-left px-4 py-2">Owner</th>
              <th class="text-left px-4 py-2">Controls</th>
              <th class="text-left px-4 py-2">Updated</th>
              <th class="px-4 py-2"></th>
            </tr>
          </thead>
          <tbody>
            {% for r in risks %}
              <tr class="border-t">
                <td class="align-top px-4 py-3">
                  <div class="font-medium">
                    {{ r.code or ('R-' ~ r.id) }} — {{ r.title or '(untitled)' }}
                  </div>
                  {% if r.category %}
                    <div class="text-xs text-gray-500 mt-0.5">{{ r.category }}</div>
                  {% endif %}
                </td>

                <td class="align-top px-4 py-3">
                  {% set st = (r.status or 'Open') %}
                  <span class="inline-block px-2 py-0.5 rounded-full text-xs
                               {% if st|lower == 'open' %}bg-amber-100 text-amber-900
                               {% elif st|lower in ['mitigated','in progress'] %}bg-blue-100 text-blue-900
                               {% elif st|lower == 'closed' %}bg-emerald-100 text-emerald-900
                               {% else %}bg-gray-100 text-gray-900{% endif %}">
                    {{ st }}
                  </span>
                </td>

                <td class="align-top px-4 py-3">
                  {% set sev = (r.severity or '') %}
                  <span class="inline-block px-2 py-0.5 rounded-full text-xs
                               {% if sev|lower in ['high','severe'] %}bg-red-100 text-red-900
                               {% elif sev|lower in ['medium','moderate'] %}bg-amber-100 text-amber-900
                               {% elif sev|lower in ['low'] %}bg-emerald-100 text-emerald-900
                               {% else %}bg-gray-100 text-gray-900{% endif %}">
                    {{ sev or '—' }}
                  </span>
                </td>

                <td class="align-top px-4 py-3">
                  {% if r.owner_name %}
                    <div>{{ r.owner_name }}</div>
                    {% if r.owner_email %}
                      <div class="text-xs">
                        <a class="hover:underline" href="mailto:{{ r.owner_email }}">{{ r.owner_email }}</a>
                      </div>
                    {% endif %}
                  {% else %}
                    <span class="text-gray-400">Unassigned</span>
                  {% endif %}
                </td>

                <td class="align-top px-4 py-3">
                  {% if r.controls and r.controls|length %}
                    <ul class="space-y-0.5">
                      {% for c in r.controls[:4] %}
                        <li>
                          <a class="hover:underline" href="/orgs/{{ org_id }}/org-controls/{{ c.id }}">
                            {{ c.code or ('C-' ~ c.id) }} — {{ c.title }}
                          </a>
                        </li>
                      {% endfor %}
                      {% if r.controls|length > 4 %}
                        <li class="text-xs text-gray-500">+ {{ r.controls|length - 4 }} more</li>
                      {% endif %}
                    </ul>
                  {% elif r.controls_count is defined %}
                    <span class="text-gray-500">{{ r.controls_count }} linked</span>
                  {% else %}
                    <span class="text-gray-400">None</span>
                  {% endif %}
                </td>

                <td class="align-top px-4 py-3 text-gray-600">
                  {{ r.updated_at or r.created_at or '—' }}
                </td>

                <td class="align-top px-4 py-3 text-right whitespace-nowrap">
                  <button
                    type="button"
                    class="px-3 py-1.5 border rounded-md hover:bg-gray-50 js-open-risk"
                    data-risk-id="{{ r.id }}"
                    data-risk-code="{{ r.code or ('R-' ~ r.id) }}"
                    data-risk-title="{{ r.title or '(untitled)' }}"
                    data-risk-status="{{ r.status or 'Open' }}"
                    data-risk-severity="{{ r.severity or '' }}"
                    data-risk-category="{{ r.category or '' }}"
                    data-risk-owner="{{ r.owner_name or '' }}"
                    data-risk-owner-email="{{ r.owner_email or '' }}"
                    data-risk-description="{{ (r.description or '')|e }}"
                    data-risk-updated="{{ r.updated_at or r.created_at or '' }}"
                  >
                    Open
                  </button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if total_pages and total_pages > 1 %}
        <nav class="flex gap-2 justify-end text-sm mt-3">
          {% for n in page_numbers %}
            {% if n == page %}
              <span class="px-3 py-1.5 border rounded-md bg-gray-50">{{ n }}</span>
            {% else %}
              <a class="px-3 py-1.5 border rounded-md hover:bg-gray-50"
                 href="?page={{ n }}{% if active.status %}&status={{ active.status|urlencode }}{% endif %}{% if active.severity %}&severity={{ active.severity|urlencode }}{% endif %}{% if active.category %}&category={{ active.category|urlencode }}{% endif %}">
                {{ n }}
              </a>
            {% endif %}
          {% endfor %}
        </nav>
      {% endif %}
    {% endif %}
  </main>
</div>

<!-- Risk detail + map control dialog -->
<dialog id="dlgRiskDetail"
        style="border:none; border-radius:16px; padding:0; max-width:960px; width:96%;">
  <form method="post"
        action="/orgs/{{ org_id }}/org-risks/link-control"
        style="padding:1.25rem 1.5rem 1.5rem; background:#fff; border:1px solid var(--line); border-radius:16px; max-height:90vh; overflow:auto;">

    <input type="hidden" name="risk_id" id="riskIdField">

    <div class="flex items-start justify-between mb-4 gap-4">
      <div>
        <div class="text-xs text-gray-500 mb-1" id="riskCodeBadge"></div>
        <h2 class="text-lg font-semibold text-gray-900" id="riskTitleHeading">Risk title</h2>
        <div class="text-xs text-gray-500 mt-1" id="riskMetaLine"></div>
      </div>
      <div class="flex flex-col gap-2 items-end text-sm">
        <span id="riskStatusBadge"></span>
        <span id="riskSeverityBadge"></span>
      </div>
    </div>

    <div class="mb-4">
      <h3 class="text-sm font-semibold text-gray-900 mb-1">Description</h3>
      <p class="text-sm text-gray-700 whitespace-pre-wrap" id="riskDescriptionText">
        –
      </p>
    </div>

    <hr class="my-4 border-gray-200">

    <div class="mb-3">
      <h3 class="text-sm font-semibold text-gray-900 mb-1">Link a control to this risk</h3>
      {% if controls %}
        <p class="text-xs text-gray-500 mb-3">
          Pick an organisation or site control and click <strong>Link control</strong>.
        </p>
        <div class="grid gap-3 md:grid-cols-[minmax(0,2fr)_minmax(0,1fr)] items-end">
          <label class="text-sm">
            <span class="block text-xs font-medium text-gray-700 mb-1">Control</span>
            <select name="control_id" required
                    class="w-full rounded-md border border-gray-300 px-2.5 py-1.5 text-sm">
              <option value="">Select a control…</option>
              {% for c in controls %}
                <option value="{{ c.id }}">
                  {{ c.code or '—' }} — {{ c.title }}{% if c.site_name %} ({{ c.site_name }}){% endif %}
                </option>
              {% endfor %}
            </select>
          </label>

          <button type="submit"
                  class="px-3 py-2 text-sm rounded-md bg-emerald-600 text-white hover:bg-emerald-700">
            Link control
          </button>
        </div>
      {% else %}
        <p class="text-xs text-gray-500">
          No controls available yet. Create organisation or site controls first, then you can map them here.
        </p>
      {% endif %}
    </div>

    <div class="mt-6 flex justify-end gap-2">
      <button type="button" class="btn small" id="btnRiskDetailCancel">Close</button>
    </div>
  </form>
</dialog>

<script>
  (function () {
    const dlg = document.getElementById('dlgRiskDetail');
    if (!dlg) return;

    const cancelBtn   = document.getElementById('btnRiskDetailCancel');
    const riskIdField = document.getElementById('riskIdField');

    const codeEl   = document.getElementById('riskCodeBadge');
    const titleEl  = document.getElementById('riskTitleHeading');
    const metaEl   = document.getElementById('riskMetaLine');
    const descEl   = document.getElementById('riskDescriptionText');
    const statusEl = document.getElementById('riskStatusBadge');
    const sevEl    = document.getElementById('riskSeverityBadge');

    function makeBadge(el, label, cls) {
      if (!label) {
        el.textContent = '';
        el.removeAttribute('class');
        return;
      }
      el.textContent = label;
      el.className =
        'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border ' + cls;
    }

    document.querySelectorAll('.js-open-risk').forEach(function (btn) {
      btn.addEventListener('click', function () {
        const d = btn.dataset;

        riskIdField.value = d.riskId || '';

        const codeBits = [];
        if (d.riskCode) codeBits.push(d.riskCode);
        if (d.riskCategory) codeBits.push(d.riskCategory);
        codeEl.textContent = codeBits.join(' — ');

        titleEl.textContent = d.riskTitle || 'Risk';

        const ownerBits = [];
        if (d.riskOwner) ownerBits.push(d.riskOwner);
        if (d.riskOwnerEmail) ownerBits.push('(' + d.riskOwnerEmail + ')');
        const updated = d.riskUpdated || '';
        metaEl.textContent = [ownerBits.join(' '), updated].filter(Boolean).join(' • ');

        descEl.textContent = d.riskDescription || 'No description recorded yet.';

        makeBadge(statusEl, d.riskStatus || 'Open',
          'border-amber-200 bg-amber-50 text-amber-800');
        makeBadge(sevEl, d.riskSeverity || '',
          'border-rose-200 bg-rose-50 text-rose-800');

        dlg.showModal();
      });
    });

    if (cancelBtn) {
      cancelBtn.addEventListener('click', function () {
        dlg.close();
      });
    }
  })();
</script>
{% endblock %}
