<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>My saved</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:1rem}
    .wrap{display:grid;grid-template-columns:260px 1fr;gap:1rem}
    aside{border:1px solid #eee;border-radius:12px;padding:1rem}
    .cards{list-style:none;padding:0;display:grid;gap:.75rem}
    .card{border:1px solid #eee;border-radius:12px;padding:1rem}
    .btn{background:#fff;border:1px solid #ccc;border-radius:6px;padding:.35rem .6rem;cursor:pointer}
    .btn.small{font-size:.85rem;padding:.25rem .5rem}
    .muted{color:#666}
    .folder-active{font-weight:700}
    input[type="text"]{width:100%;padding:.45rem .6rem;border:1px solid #ccc;border-radius:6px}
    .row{display:flex;gap:.5rem;margin-top:.5rem}
  </style>
</head>
<body>
<header style="display:flex;justify-content:space-between;align-items:center;padding:.75rem 1rem;border-bottom:1px solid #eee">
  <a href="/summaries" style="text-decoration:none;color:inherit;"><strong>Compliance Summaries</strong></a>
  <nav style="display:flex;gap:.5rem;align-items:center;">
    {% if uid %}
      <a class="btn small" href="/saved">My saved</a>
      <form method="post" action="/account/logout" style="margin:0;">
        <button class="btn small" type="submit">Logout</button>
      </form>
    {% else %}
      <a class="btn small" href="/account/login">Login</a>
      <a class="btn small" href="/account/register">Register</a>
    {% endif %}
  </nav>
</header>

<div class="wrap">
  <aside>
    <h3>Folders</h3>
    <ul style="list-style:none;padding:0;margin:0 0 .5rem 0">
      <li>
        <a href="/saved" class="{% if not active_folder %}folder-active{% endif %}">All saved</a>
      </li>
      {% for f in folders %}
        <li>
          <a href="/saved?folder_id={{ f.id }}" class="{% if active_folder == f.id %}folder-active{% endif %}">{{ f.name }}</a>
        </li>
      {% endfor %}
    </ul>

    <form method="post" action="/folders/new" class="row">
      <input type="text" name="name" placeholder="New folder name" required>
      <button class="btn small" type="submit">Create</button>
    </form>

    <form method="post" action="/account/logout" style="margin-top:1rem;">
      <button class="btn small" type="submit">Logout</button>
    </form>
  </aside>

  <main>
    <h2>
      Saved items
      {% if active_folder_name %}
        — {{ active_folder_name }}
      {% elif active_folder %}
        — Folder {{ active_folder }}
      {% endif %}
    </h2>

    {% if error %}
      <div class="card" style="border-color:#f3c2c2;background:#fff7f7;color:#8a1f1f">{{ error }}</div>
    {% endif %}

    <ul class="cards">
      {% for it in items %}
        <li class="card">
          <div><a href="{{ it.link }}" target="_blank" rel="noopener">{{ it.title }}</a></div>
          <div class="muted">{{ it.published_at }}{% if it.folder %} · Folder: {{ it.folder }}{% endif %}</div>
          <div style="margin-top:.5rem;">
            <!-- FIXED: pass GUID as quoted string & close paren -->
            <button class="btn small" onclick="removeSaved('{{ it.guid|e }}')">Remove</button>
          </div>
        </li>
      {% else %}
        <li class="card">No saved items yet.</li>
      {% endfor %}
    </ul>
  </main>
</div>

<script>
async function removeSaved(guid){
  try{
    const res = await fetch('/api/unsave?guid=' + encodeURIComponent(guid), {
      method: 'DELETE',
      credentials: 'same-origin'
    });
    if(!res.ok){
      const t = await res.text().catch(()=> '');
      alert('Failed to remove.\n' + t);
      return;
    }
    location.reload();
  }catch(err){
    alert('Failed to remove.\n' + (err?.message || err));
  }
}
</script>

</body>
</html>
