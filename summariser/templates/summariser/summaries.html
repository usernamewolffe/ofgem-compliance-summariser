<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Compliance Summaries</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --brand:#0a66c2; --muted:#666; --border:#eee; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; }
    .wrap { display:grid; grid-template-columns: 280px 1fr; gap: 1rem; padding: 1rem; }
    aside { border:1px solid var(--border); border-radius:12px; padding:1rem; }
    .cards { list-style:none; padding:0; display:grid; gap:.75rem; }
    .card { border:1px solid var(--border); border-radius:12px; padding:1rem; }
    .muted { color:var(--muted); font-size:.9rem; }
    form.inline { display:flex; gap:.5rem; align-items:center; margin-bottom:1rem; flex-wrap:wrap; }
    label.chk { display:flex; gap:.5rem; align-items:center; margin:.25rem 0; }
    .dropdown { position:relative; }
    .dropdown button { background:#fff; border:1px solid #ccc; border-radius:6px; padding:0.4rem 0.6rem; cursor:pointer; }
    .dropdown-menu { display:none; position:absolute; top:110%; left:0; background:#fff; border:1px solid #ccc; border-radius:6px; padding:.5rem; box-shadow:0 2px 6px rgba(0,0,0,0.1); z-index:10; min-width:220px; max-height: 40vh; overflow:auto; }
    .dropdown-menu label { display:flex; align-items:center; gap:.5rem; margin:.25rem 0; }
    .dropdown.open .dropdown-menu { display:block; }

    .badge { display:inline-block; margin-left:.5rem; padding:.15rem .4rem; border-radius:999px; border:1px solid var(--brand); color:var(--brand); font-size:.72rem; vertical-align:middle; }

    .btn { background:#fff; border:1px solid #ccc; border-radius:6px; padding:.35rem .6rem; cursor:pointer; }
    .btn.primary { border-color:var(--brand); color:var(--brand); }
    .btn.small { font-size:.85rem; padding:.25rem .5rem; }
    .row { display:flex; gap:.5rem; align-items:center; }
    .row.spread { justify-content:space-between; }

    /* Modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal { background:#fff; border-radius:12px; padding:1rem; max-width:640px; width:90%; box-shadow:0 10px 30px rgba(0,0,0,.2); }
    .modal h3 { margin:0 0 .5rem 0; }
    .modal .actions { display:flex; justify-content:flex-end; gap:.5rem; margin-top:1rem; }

    /* Saved filters */
    .saved { margin-top:1rem; border-top:1px dashed var(--border); padding-top:1rem; }
    .saved-list { display:flex; flex-direction:column; gap:.4rem; margin:.5rem 0 0; }
    .saved-item { display:flex; align-items:center; justify-content:space-between; gap:.5rem; padding:.3rem .4rem; border:1px solid #f1f1f1; border-radius:8px; }
    .saved-item a { text-decoration:none; color:inherit; }
    .saved-actions { display:flex; gap:.3rem; }
    .danger { color:#b32d2e; border-color:#b32d2e; }
  </style>
</head>
<body>
  <!-- Top nav -->
  <header style="display:flex;justify-content:space-between;align-items:center;padding:.75rem 1rem;border-bottom:1px solid #eee;background:#fafafa;position:sticky;top:0;z-index:10;">
    <a href="/summaries" style="text-decoration:none;color:inherit;"><strong>Compliance Summaries</strong></a>
    <nav style="display:flex;gap:.5rem;align-items:center;">
      {% if uid %}
        <a class="btn small" href="/saved">My saved</a>
        <form method="post" action="/account/logout" style="margin:0;">
          <button class="btn small" type="submit">Logout</button>
        </form>
      {% else %}
        <a class="btn small" href="/account/login">Login</a>
        <a class="btn small" href="/account/register">Register</a>
      {% endif %}
    </nav>
  </header>

  <div class="wrap">
    <aside>
      <form method="get" id="source-form">
        <h3 style="margin-top:0;">Sources</h3>

        <div class="row" style="gap:.35rem; margin:.25rem 0 .5rem;">
          <button type="button" class="btn small" id="selectAllSources">Select all</button>
          <button type="button" class="btn small" id="clearAllSources">Unselect all</button>
        </div>

        {% for s in all_sources %}
            <label class="chk">
              <input type="checkbox" name="sources" value="{{ s }}"
                     {% if s in active.sources %}checked{% endif %}>
              <span style="text-transform:capitalize">{{ s }}</span>
            </label>
        {% endfor %}
        <input type="hidden" name="q" value="{{ active.q }}">
        <input type="hidden" name="date_from" value="{{ active.date_from }}">
        <input type="hidden" name="date_to" value="{{ active.date_to }}">
        <input type="hidden" name="per_page" value="{{ active.per_page }}">
        <input type="hidden" name="page" value="1">
        {% for t in active.topics %}
          <input type="hidden" name="topics" value="{{ t }}">
        {% endfor %}
        <button type="submit" class="btn small" style="margin-top:.75rem;">Apply</button>
      </form>

      <!-- Saved filters block -->
      <div class="saved">
        <div class="row spread">
          <h3 style="margin:0;">Saved filters</h3>
          <button id="refreshSaved" class="btn small">Refresh</button>
        </div>

        <div class="row" style="margin:.5rem 0;">
          <input id="saveName" type="text" placeholder="Name this filter…" style="flex:1; padding:.4rem .5rem; border:1px solid #ccc; border-radius:6px;">
          <button id="saveFilter" class="btn primary small">Save</button>
        </div>

        <div id="savedList" class="saved-list">
          <div class="muted">Loading…</div>
        </div>
      </div>
    </aside>

    <main>
      <form class="inline" method="get">
        <input type="search" name="q" placeholder="Search…" value="{{ active.q }}">
        <input type="date" name="date_from" value="{{ active.date_from }}">
        <input type="date" name="date_to" value="{{ active.date_to }}">

        <div class="dropdown" id="topicDropdown">
          <button type="button" id="topicToggle" aria-haspopup="true" aria-expanded="false">Topics ▾</button>
          <div class="dropdown-menu" role="menu" aria-label="Topics">
            <div class="row" style="gap:.35rem; margin-bottom:.5rem;">
              <button type="button" class="btn small" id="selectAllTopics">Select all</button>
              <button type="button" class="btn small" id="clearAllTopics">Unselect all</button>
            </div>
            {% for t in all_topics %}
              <label>
                <input type="checkbox" name="topics" value="{{ t }}"
                  {% if (not active.topics) or (t in active.topics) %}checked{% endif %}>
                {{ t }}
              </label>
            {% endfor %}
          </div>
        </div>

        {% for s in active.sources %}
          <input type="hidden" name="sources" value="{{ s }}">
        {% endfor %}

        <select name="per_page">
          {% for n in [10,25,50,100] %}
            <option value="{{ n }}" {% if active.per_page == n %}selected{% endif %}>{{ n }} / page</option>
          {% endfor %}
        </select>
        <input type="hidden" name="page" value="1">
        <button type="submit" class="btn primary">Filter</button>
      </form>

      <ul class="cards">
        {% for e in entries %}
          <li class="card">
            <article>
              <h4 style="margin:.2rem 0;">
                <a href="{{ e.link }}" target="_blank" rel="noopener">{{ e.title }}</a>
                {% if 'ofgem.gov.uk' in (e.link or '') %}
                  <span class="badge">Ofgem Publications</span>
                {% endif %}
              </h4>
              <div class="muted">
                {{ (e.source or "")|upper }} · {{ e.published_at }}
              </div>
              <p>
                {% if e.summary %}{{ e.summary }}
                {% elif e.content %}{{ e.content[:220] }}{% if e.content|length > 220 %}…{% endif %}
                {% endif %}
              </p>
              {% if e.tags %}
                <div class="muted">
                  Tags:
                  {% if e.tags is string %}
                    {{ e.tags.strip("[]").replace("'", "").replace('"', '') }}
                  {% else %}
                    {{ ", ".join(e.tags) }}
                  {% endif %}
                </div>
              {% endif %}

              <div style="margin-top:.5rem;">
                <button type="button" class="btn save-btn" data-guid="{{ e.guid or e.link }}">Save</button>
                <button type="button" class="btn ai-btn" data-guid="{{ e.guid or e.link }}">AI summary (≤100 words)</button>
              </div>
            </article>
          </li>
        {% else %}
          <li>No results.</li>
        {% endfor %}
      </ul>

      {% if total_pages > 1 %}
      <nav class="pagination" style="margin-top:1rem;">
        {% for num in page_numbers %}
          {% if num == page %}
            <strong>{{ num }}</strong>
          {% else %}
            <a href="?page={{ num }}&per_page={{ active.per_page }}{% if active.q %}&q={{ active.q|urlencode }}{% endif %}{% if active.date_from %}&date_from={{ active.date_from }}{% endif %}{% if active.date_to %}&date_to={{ active.date_to }}{% endif %}{% for s in active.sources %}&sources={{ s|urlencode }}{% endfor %}{% for t in active.topics %}&topics={{ t|urlencode }}{% endfor %}">{{ num }}</a>
          {% endif %}
        {% endfor %}
      </nav>
      {% endif %}
    </main>
  </div>

  <!-- AI Modal -->
  <div id="aiModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="aiModalTitle">
      <h3 id="aiModalTitle">AI summary</h3>
      <div id="aiModalBody" class="muted">Preparing summary…</div>
      <div class="actions">
        <button type="button" class="btn" id="aiModalClose">Close</button>
      </div>
    </div>
  </div>

  <!-- Save Modal -->
  <div id="saveModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="saveTitle">
      <h3 id="saveTitle">Save to folder</h3>
      <div class="muted" style="margin-bottom:.5rem;">Choose a folder or create one.</div>
      <select id="folderSelect" style="width:100%;margin:.25rem 0;"></select>
      <div class="row" style="margin-top:.5rem;">
        <input id="newFolderName" placeholder="New folder name" style="flex:1;">
        <button class="btn" id="createFolderBtn" type="button">Create</button>
      </div>
      <div class="actions">
        <button type="button" class="btn" id="saveCancel">Cancel</button>
        <button type="button" class="btn primary" id="saveConfirm">Save</button>
      </div>
    </div>
  </div>

  <script>
    // Auto-submit sources form when changed
    const f = document.getElementById('source-form');


    // Topic dropdown toggle
    const dropdown = document.getElementById('topicDropdown');
    const toggle = document.getElementById('topicToggle');
    if (toggle) {
      toggle.addEventListener('click', () => {
        const open = dropdown.classList.toggle('open');
        toggle.setAttribute('aria-expanded', String(open));
      });
      document.addEventListener('click', (e) => {
        if (!dropdown.contains(e.target)) {
          dropdown.classList.remove('open');
          toggle.setAttribute('aria-expanded', 'false');
        }
      });
    }

    // ---------- Select/Unselect All ----------
// ---------- Select/Unselect All (Sources) ----------
const sourceForm = document.getElementById('source-form');
const selectAllSourcesBtn = document.getElementById('selectAllSources');
const clearAllSourcesBtn  = document.getElementById('clearAllSources');

function setAllSources(checked) {
  document
    .querySelectorAll('#source-form input[type="checkbox"][name="sources"]')
    .forEach(cb => { cb.checked = checked; });
  // Do NOT auto-submit; user will press Apply
}

selectAllSourcesBtn?.addEventListener('click', () => setAllSources(true));
clearAllSourcesBtn?.addEventListener('click', () => setAllSources(false));


    // Topics – user confirms with the main Filter button
    const selectAllTopicsBtn = document.getElementById('selectAllTopics');
    const clearAllTopicsBtn  = document.getElementById('clearAllTopics');
    function setAllTopics(checked) {
      document.querySelectorAll('#topicDropdown .dropdown-menu input[type="checkbox"][name="topics"]').forEach(cb => { cb.checked = checked; });
    }
    selectAllTopicsBtn?.addEventListener('click', () => setAllTopics(true));
    clearAllTopicsBtn?.addEventListener('click', () => setAllTopics(false));

    // ---------- AI modal logic ----------
    const aiModal = document.getElementById('aiModal');
    const aiModalBody = document.getElementById('aiModalBody');
    const aiModalClose = document.getElementById('aiModalClose');
    function openAIModal(text) {
      aiModalBody.textContent = text || 'Preparing summary…';
      aiModal.style.display = 'flex';
      aiModal.setAttribute('aria-hidden', 'false');
    }
    function closeAIModal() {
      aiModal.style.display = 'none';
      aiModal.setAttribute('aria-hidden', 'true');
    }
    aiModalClose.addEventListener('click', closeAIModal);
    aiModal.addEventListener('click', (e) => { if (e.target === aiModal) closeAIModal(); });

    // Wire up AI buttons
    document.querySelectorAll('.ai-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const guid = btn.getAttribute('data-guid');
        openAIModal('Summarising…');
        try {
          const res = await fetch('/api/ai-summary', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ guid })
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.detail || `HTTP ${res.status}`);
          }
          const data = await res.json();
          aiModalBody.textContent = data.summary || 'No summary produced.';
        } catch (e) {
          aiModalBody.textContent = 'Sorry — failed to generate a summary.';
          console.error(e);
        }
      });
    });

    // ---------- Save modal wiring ----------
    (function(){
      let pendingGuid = null;

      function openSaveModal(guid){
        pendingGuid = guid;
        const modal = document.getElementById('saveModal');
        modal.style.display = 'flex';
        modal.setAttribute('aria-hidden','false');
        loadFolders();
      }
      function closeSaveModal(){
        pendingGuid = null;
        const modal = document.getElementById('saveModal');
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden','true');
      }
      async function loadFolders(){
        const sel = document.getElementById('folderSelect');
        sel.innerHTML = '<option value="">(No folder)</option>';
        try{
          const r = await fetch('/api/folders', { credentials: 'same-origin' });
          if(r.status === 401){ alert('Please sign in to save.'); closeSaveModal(); return; }
          const data = await r.json();
          (data.folders || []).forEach(f=>{
            const o=document.createElement('option'); o.value=f.id; o.textContent=f.name; sel.appendChild(o);
          });
        }catch(e){ console.error(e); }
      }
      async function createFolder(){
        const input = document.getElementById('newFolderName');
        const name  = (input.value||'').trim();
        if(!name){ alert('Enter a folder name'); return; }
        try{
          const r = await fetch('/api/folders', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            credentials:'same-origin',
            body: JSON.stringify({ name })
          });
          if(r.status === 401){ alert('Please sign in to create folders.'); location.href='/account/login'; return; }
          if(!r.ok){ const err = await r.json().catch(()=>({})); alert(err.detail || 'Failed to create folder.'); return; }
          input.value = '';
          await loadFolders();
        }catch(e){ console.error(e); alert('Network error while creating the folder.'); }
      }
      async function saveItem(){
        if(!pendingGuid) return;
        const folder_id = document.getElementById('folderSelect').value || null;
        const r = await fetch('/api/save', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'same-origin',
          body: JSON.stringify({guid: pendingGuid, folder_id: folder_id ? Number(folder_id) : null})
        });
        if(r.status === 401){ alert('Please sign in to save.'); return; }
        if(!r.ok){ alert('Failed to save.'); return; }
        closeSaveModal();
      }

      document.querySelectorAll('.save-btn').forEach(b=>{
        b.addEventListener('click', ()=> openSaveModal(b.getAttribute('data-guid')));
      });
      document.getElementById('createFolderBtn')?.addEventListener('click', createFolder);
      document.getElementById('saveConfirm')?.addEventListener('click', saveItem);
      document.getElementById('saveCancel')?.addEventListener('click', closeSaveModal);
      document.getElementById('saveModal')?.addEventListener('click', (e)=>{ if(e.target.id==='saveModal') closeSaveModal(); });
    })();

    // -------- Saved filters (create/list/apply/delete) ----------
    async function loadSaved() {
      const list = document.getElementById('savedList');
      if (!list) return;
      list.innerHTML = '<div class="muted">Loading…</div>';
      try {
        const r = await fetch('/api/saved-filters');
        const data = await r.json();
        const filters = (data && data.filters) || [];
        if (!filters.length) {
          list.innerHTML = '<div class="muted">No saved filters yet.</div>';
          return;
        }
        list.innerHTML = '';
        filters.forEach(f => {
          const row = document.createElement('div');
          row.className = 'saved-item';
          const left = document.createElement('div');
          left.innerHTML = `<strong>${f.name}</strong>`;
          const actions = document.createElement('div');
          actions.className = 'saved-actions';
          const applyBtn = document.createElement('a');
          applyBtn.className = 'btn small';
          applyBtn.href = `/apply-saved-filter?filter_id=${encodeURIComponent(f.id)}`;
          applyBtn.textContent = 'Apply';
          const delBtn = document.createElement('button');
          delBtn.className = 'btn small danger';
          delBtn.textContent = 'Delete';
          delBtn.addEventListener('click', async () => {
            if (!confirm('Delete saved filter?')) return;
            await fetch(`/api/saved-filters/${f.id}`, { method: 'DELETE' });
            loadSaved();
          });
          actions.append(applyBtn, delBtn);
          row.append(left, actions);
          list.appendChild(row);
        });
      } catch(e) {
        console.error(e);
        list.innerHTML = '<div class="muted">Failed to load saved filters.</div>';
      }
    }
    document.getElementById('saveFilter')?.addEventListener('click', async (e) => {
      e.preventDefault();
      const nameInput = document.getElementById('saveName');
      const name = (nameInput.value || '').trim();
      if (!name) { alert('Name your filter first.'); return; }
      const url = new URL(window.location.href);
      const params = new URLSearchParams(url.search);
      const payload = { name, params: {} };
      ['q','date_from','date_to','per_page'].forEach(k => { const v = params.get(k); if (v) payload.params[k] = v; });
      ['sources','topics'].forEach(k => { const vals = [...params.getAll(k)]; if (vals.length) payload.params[k] = vals; });
      const res = await fetch('/api/saved-filters', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) { alert('Failed to save filter.'); return; }
      nameInput.value = '';
      loadSaved();
    });
    document.getElementById('refreshSaved')?.addEventListener('click', (e) => {
      e.preventDefault();
      loadSaved();
    });
    loadSaved();
  </script>
</body>
</html>
