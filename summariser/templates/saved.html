{% extends "base.html" %}

{% block title %}My Saved Items{% endblock %}

{% block content %}
<div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 py-4 grid gap-4 lg:grid-cols-[260px_1fr]">

  <!-- Sidebar -->
  <aside class="rounded-xl border border-gray-100 p-4 bg-white">
    <h3 class="text-base font-semibold mb-2">Folders</h3>
    <ul class="space-y-1 text-sm">
      <li>
        <a href="/saved" class="hover:underline {% if not active_folder %}font-semibold{% endif %}">All saved</a>
      </li>
      {% for f in folders %}
        <li>
          <a href="/saved?folder_id={{ f.id }}" class="hover:underline {% if active_folder == f.id %}font-semibold{% endif %}">{{ f.name }}</a>
        </li>
      {% endfor %}
    </ul>

    <form method="post" action="/folders/new" class="mt-3 flex gap-2">
      <input type="text" name="name" placeholder="New folder name" required
             class="flex-1 rounded-md border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
      <button class="px-3 py-2 text-sm border rounded-md hover:bg-gray-50" type="submit">Create</button>
    </form>

    <form method="post" action="/account/logout" class="mt-4">
      <button class="px-3 py-1.5 text-sm border rounded-md hover:bg-gray-50" type="submit">Logout</button>
    </form>
  </aside>

  <!-- Main -->
  <main class="bg-white rounded-xl border border-gray-100 p-4">
    <h2 class="text-lg font-semibold">
      Saved items
      {% if active_folder_name %}
        — {{ active_folder_name }}
      {% elif active_folder %}
        — Folder {{ active_folder }}
      {% endif %}
    </h2>

    {% if error %}
      <div class="mt-3 rounded-xl border border-red-200 bg-red-50 p-3 text-sm text-red-800">
        {{ error }}
      </div>
    {% endif %}

    <ul class="mt-4 grid gap-3">
      {% for it in items %}
        <li class="rounded-xl border border-gray-100 p-4 transition-opacity" data-guid="{{ it.guid|e }}">
          <div class="font-medium"><a href="{{ it.link }}" target="_blank" rel="noopener" class="hover:underline">{{ it.title }}</a></div>
          <div class="text-xs text-gray-500 mt-0.5">
            {{ it.published_at }}{% if it.folder %} · Folder: {{ it.folder }}{% endif %}
          </div>
          <div class="mt-3">
            <button class="px-3 py-1.5 text-sm border rounded-md hover:bg-gray-50"
                    data-guid="{{ it.guid|e }}"
                    onclick="removeSaved('{{ it.guid|e }}')">Remove</button>
          </div>
        </li>
      {% else %}
        <li class="rounded-xl border border-gray-100 p-4 text-sm text-gray-500">No saved items yet.</li>
      {% endfor %}
    </ul>
  </main>
</div>
{% endblock %}

{% block scripts %}
<script>
async function removeSaved(guid){
  const ok = window.confirm("Remove this item from your saved list?");
  if(!ok) return;

  const btns = document.querySelectorAll(`button[data-guid="${CSS.escape(guid)}"]`);
  btns.forEach(b => { b.disabled = true; b.textContent = "Removing…"; });

  try{
    const res = await fetch('/api/unsave?guid=' + encodeURIComponent(guid), {
      method: 'DELETE',
      credentials: 'same-origin'
    });
    if(!res.ok){
      const t = await res.text().catch(()=> '');
      alert('Failed to remove.\n' + t);
      btns.forEach(b => { b.disabled = false; b.textContent = "Remove"; });
      return;
    }

    // Smoothly remove card
    const card = btns[0]?.closest('li');
    if (card) {
      card.style.opacity = 0.3;
      setTimeout(() => card.remove(), 300);
    } else {
      location.reload();
    }
  }catch(err){
    alert('Failed to remove.\n' + (err?.message || err));
    btns.forEach(b => { b.disabled = false; b.textContent = "Remove"; });
  }
}
</script>
{% endblock %}
